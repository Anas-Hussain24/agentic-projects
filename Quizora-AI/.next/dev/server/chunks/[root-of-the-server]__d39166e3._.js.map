{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///D:/agentic-projects/Quizora-AI/src/lib/agent.ts"],"sourcesContent":["import { GoogleGenerativeAI } from '@google/generative-ai';\r\nimport pdf from 'pdf-parse';\r\n\r\nexport class StudyAgent {\r\n  private model: any;\r\n\r\n  constructor() {\r\n    console.log('Environment variables:', {\r\n      GEMINI_API_KEY: process.env.GEMINI_API_KEY ? 'Found' : 'Not found',\r\n      NODE_ENV: process.env.NODE_ENV,\r\n      allEnvKeys: Object.keys(process.env).filter(k => k.includes('GEMINI'))\r\n    });\r\n    \r\n    const apiKey = process.env.GEMINI_API_KEY;\r\n    if (!apiKey) {\r\n      throw new Error(\"GEMINI_API_KEY not found in environment variables\");\r\n    }\r\n    const genAI = new GoogleGenerativeAI(apiKey);\r\n    // Using the official stable alias that works across all API key tiers\r\n    this.model = genAI.getGenerativeModel({ model: 'gemini-flash-latest' });\r\n  }\r\n\r\n  /**\r\n   * Retry helper with exponential backoff for rate limit errors\r\n   */\r\n  private async retryWithBackoff<T>(\r\n    fn: () => Promise<T>,\r\n    maxRetries: number = 3,\r\n    initialDelay: number = 1000\r\n  ): Promise<T> {\r\n    let lastError: any;\r\n    \r\n    for (let attempt = 0; attempt < maxRetries; attempt++) {\r\n      try {\r\n        return await fn();\r\n      } catch (error: any) {\r\n        lastError = error;\r\n        \r\n        // Check if it's a rate limit error (429)\r\n        const isRateLimit = error.status === 429 || \r\n                           error.message?.includes('429') ||\r\n                           error.message?.includes('Resource exhausted');\r\n        \r\n        if (!isRateLimit || attempt === maxRetries - 1) {\r\n          // If not a rate limit error or last attempt, throw immediately\r\n          throw error;\r\n        }\r\n        \r\n        // Calculate delay with exponential backoff\r\n        const delay = initialDelay * Math.pow(2, attempt);\r\n        console.log(`Rate limit hit, retrying in ${delay}ms (attempt ${attempt + 1}/${maxRetries})...`);\r\n        \r\n        await new Promise(resolve => setTimeout(resolve, delay));\r\n      }\r\n    }\r\n    \r\n    throw lastError;\r\n  }\r\n\r\n  async extractTextFromPdf(buffer: Buffer): Promise<string> {\r\n    try {\r\n      const data = await pdf(buffer);\r\n      return data.text;\r\n    } catch (e: any) {\r\n      throw new Error(`Error reading PDF: ${e.message}`);\r\n    }\r\n  }\r\n\r\n  async generateSummary(text: string): Promise<string> {\r\n    const prompt = `\r\n    You are an expert study assistant. Please provide a clean, meaningful summary of the following text.\r\n    The summary should be structured and easy to read for students.\r\n    \r\n    Text:\r\n    ${text.slice(0, 30000)}\r\n    \r\n    Summary:\r\n    `;\r\n\r\n    try {\r\n      return await this.retryWithBackoff(async () => {\r\n        const result = await this.model.generateContent(prompt);\r\n        const response = await result.response;\r\n        return response.text();\r\n      });\r\n    } catch (error: any) {\r\n      const isRateLimit = error.status === 429 || \r\n                         error.message?.includes('429') ||\r\n                         error.message?.includes('Resource exhausted');\r\n      \r\n      if (isRateLimit) {\r\n        throw new Error('API rate limit exceeded. Please try again in a few moments.');\r\n      }\r\n      throw new Error(`Failed to generate summary: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async generateQuiz(text: string, numQuestions: number = 5): Promise<any[]> {\r\n    const prompt = `\r\n    You are an expert study assistant. Create a quiz based on the following text.\r\n    Generate ${numQuestions} multiple choice questions.\r\n    Return the result ONLY as a valid JSON array of objects.\r\n    Each object should have:\r\n    - \"question\": string\r\n    - \"options\": array of 4 strings\r\n    - \"answer\": string (the correct option text)\r\n    \r\n    Do not include markdown formatting like \\`\\`\\`json ... \\`\\`\\`. Just the raw JSON string.\r\n\r\n    Text:\r\n    ${text.slice(0, 30000)}\r\n    \r\n    JSON:\r\n    `;\r\n\r\n    try {\r\n      return await this.retryWithBackoff(async () => {\r\n        const result = await this.model.generateContent(prompt);\r\n        const response = await result.response;\r\n        let textResponse = response.text().trim();\r\n\r\n        // Clean up potential markdown formatting\r\n        if (textResponse.startsWith(\"```json\")) {\r\n          textResponse = textResponse.slice(7);\r\n        }\r\n        if (textResponse.startsWith(\"```\")) {\r\n          textResponse = textResponse.slice(3);\r\n        }\r\n        if (textResponse.endsWith(\"```\")) {\r\n          textResponse = textResponse.slice(0, -3);\r\n        }\r\n\r\n        try {\r\n          return JSON.parse(textResponse);\r\n        } catch (e) {\r\n          console.error(\"Failed to parse quiz JSON\", textResponse);\r\n          return [{ question: \"Error parsing quiz\", options: [], answer: \"\" }];\r\n        }\r\n      });\r\n    } catch (error: any) {\r\n      const isRateLimit = error.status === 429 || \r\n                         error.message?.includes('429') ||\r\n                         error.message?.includes('Resource exhausted');\r\n      \r\n      if (isRateLimit) {\r\n        throw new Error('API rate limit exceeded. Please try again in a few moments.');\r\n      }\r\n      throw new Error(`Failed to generate quiz: ${error.message}`);\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 215, "column": 0}, "map": {"version":3,"sources":["file:///D:/agentic-projects/Quizora-AI/src/app/api/process/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { StudyAgent } from '@/lib/agent';\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get('file') as File;\r\n    const mode = formData.get('mode') as string;\r\n\r\n    if (!file) {\r\n      return NextResponse.json({ success: false, error: 'No file uploaded' }, { status: 400 });\r\n    }\r\n\r\n    if (!mode || !['summary', 'quiz'].includes(mode)) {\r\n      return NextResponse.json({ success: false, error: 'Invalid mode' }, { status: 400 });\r\n    }\r\n\r\n    const bytes = await file.arrayBuffer();\r\n    const buffer = Buffer.from(bytes);\r\n\r\n    const agent = new StudyAgent();\r\n    \r\n    // Extract text\r\n    const text = await agent.extractTextFromPdf(buffer);\r\n\r\n    let result;\r\n    if (mode === 'summary') {\r\n      result = await agent.generateSummary(text);\r\n    } else if (mode === 'quiz') {\r\n      result = await agent.generateQuiz(text);\r\n    }\r\n\r\n    return NextResponse.json({ success: true, data: result });\r\n\r\n  } catch (error: any) {\r\n    console.error('API Error:', error);\r\n    \r\n    // Check if it's a rate limit error\r\n    const isRateLimit = error.message?.includes('rate limit') || \r\n                       error.message?.includes('429') ||\r\n                       error.message?.includes('Resource exhausted');\r\n    \r\n    if (isRateLimit) {\r\n      return NextResponse.json({ \r\n        success: false, \r\n        error: 'API rate limit exceeded. Please wait a moment and try again.',\r\n        details: error.message \r\n      }, { status: 429 });\r\n    }\r\n    \r\n    return NextResponse.json({ \r\n      success: false, \r\n      error: 'An error occurred while processing the file. Please try again.',\r\n      details: error.message \r\n    }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxF;QAEA,IAAI,CAAC,QAAQ,CAAC;YAAC;YAAW;SAAO,CAAC,QAAQ,CAAC,OAAO;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpF;QAEA,MAAM,QAAQ,MAAM,KAAK,WAAW;QACpC,MAAM,SAAS,OAAO,IAAI,CAAC;QAE3B,MAAM,QAAQ,IAAI,mIAAU;QAE5B,eAAe;QACf,MAAM,OAAO,MAAM,MAAM,kBAAkB,CAAC;QAE5C,IAAI;QACJ,IAAI,SAAS,WAAW;YACtB,SAAS,MAAM,MAAM,eAAe,CAAC;QACvC,OAAO,IAAI,SAAS,QAAQ;YAC1B,SAAS,MAAM,MAAM,YAAY,CAAC;QACpC;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM;QAAO;IAEzD,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,cAAc;QAE5B,mCAAmC;QACnC,MAAM,cAAc,MAAM,OAAO,EAAE,SAAS,iBACzB,MAAM,OAAO,EAAE,SAAS,UACxB,MAAM,OAAO,EAAE,SAAS;QAE3C,IAAI,aAAa;YACf,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;gBACP,SAAS,MAAM,OAAO;YACxB,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO;YACP,SAAS,MAAM,OAAO;QACxB,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}